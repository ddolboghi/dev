- 인터넷에서 모든 AS(자율 시스템)은 동일한 AS간 라우팅 프로토콜(BGP)을 실행한다.
- BGP는 거리 벡터 라우팅의 맥락에서 탈중앙화 및 비동기적 프로토콜이다.
- BGP는 복잡한 프로토콜이지만, 인터넷을 깊이 이해하려면 그 기초와 동작 방식에 익숙해져야 한다.

# BGP의 역할
BGP에서 목적지는 `138.16.68/22`와 같은 형태를 가질 수 있으며, 이는 1,024개의 IP 주소를 포함한다. 따라서 라우터의 포워딩 테이블에는 `(x, I)` 형태의 항목이 포함되며, 여기서 `x`는 접두사(`138.16.68/22`)이고 `I`는 라우터 인터페이스 번호이다.

BGP는 라우터가 수행해야 하는 두 가지 중요한 작업을 위한 수단을 제공한다.
## BGP가 라우터에게 제공하는 것
### 이웃 AS로부터 접두사(prefix) 도달 가능성 정보를 얻을 수 있다
특히 BGP는 각 서브넷이 자신의 존재를 나머지 인터넷에 알릴 수 있도록 허용한다. BGP가 없다면 각 서브넷은 고립된 섬이 되어 인터넷의 나머지 부분과 통신할 수 없다.
### 접두사로 가는 최상의 경로를 결정한다
라우터는 특정 접두사에 대해 두 개 이상의 다른 경로 정보를 학습할 수 있다.
최상의 경로를 결정하기 위해 라우터는 이웃 라우터로부터 얻은 **접두사 도달 가능성 정보**와 **정책**을 기반으로, BGP 경로 선택 절차(route-selection procedure)를 실행한다.
# BGP 라우팅 정보 교환
![[network_with_three_AS.png]]
위 그림처럼, AS들은 게이트웨이 라우터와 내부 라우터로 구성된다.
- 게이트웨이 라우터: AS의 가장자리에 위치하여 **다른 AS의 라우터와 직접 연결**되는 라우터
- 내부 라우터: 자신의 AS 내의 호스트 및 라우터에만 연결
## BGP 경로 전파
AS3에 있는 접두사 `X`에 대한 도달 가능성 정보가 다른 AS들의 모든 라우터에 전파되는 과정:
1. AS3는 AS2에게 "AS3 `X`"라는 BGP 메시지를 보내 `X`가 AS3에 있다고 알린다.
2. AS2는 AS1에게 "AS2 AS3 `X`"라는 BGP 메시지를 보내 `X`에 도달하려면 AS2를 거쳐 AS3로 가야 함을 알린다.
## eBGP와 iBGP
실제로는 AS가 아닌 라우터들이 서로 메시지를 주고받는다.
- **BGP 연결 (BGP connection)**: 라우터들은 **반영구적인 TCP 연결(포트 179)** 을 통해 라우팅 정보를 교환한다. 이 TCP 연결과 그 위에서 전송되는 모든 BGP 메시지를 BGP 연결이라고 한다.
- **eBGP (external BGP)**: 서로 다른 두 AS에 걸친 BGP 연결이다. 일반적으로 서로 다른 AS의 게이트웨이 라우터를 직접 연결하는 각 링크마다 하나의 eBGP 연결이 있다.
- **iBGP (internal BGP)**: 동일한 AS 내의 라우터 간 BGP 세션이다. iBGP 연결은 물리적 링크와 항상 일치하지는 않는다.

도달 가능성 정보는 eBGP와 iBGP 세션을 모두 사용하여 전파된다.
![[eBGP_iBGP.png]]
위 그림에서 접두사 `x`에 대한 정보는 다음과 같이 전파된다.
1. 게이트웨이 라우터 3a가 2c에게 eBGP 메시지 "AS3 `x`"를 보낸다.
2. 게이트웨이 라우터 2c는 2a를 포함한 AS2 내의 다른 모든 라우터에게 iBGP 메시지 "AS3 `x`"를 보낸다.
3. 게이트웨이 라우터 2a는 1c에게 eBGP 메시지 "AS2 AS3 `x`"를 보낸다.
4. 게이트웨이 라우터 1c는 iBGP를 사용하여 AS1 내의 모든 라우터에게 "AS2 AS3 `x`" 메시지를 보낸다.

이 과정이 끝나면 AS1과 AS2의 각 라우터는 `x`의 존재와 `x`로 가는 AS 경로를 알게 된다.
실제 네트워크에서 라우터는 `x`로 가는 여러 경로 정보를 받을 수 있다.
# 최적의 경로 결정하기
## BGP 경로 속성
라우터가 BGP 연결을 통해 접두사 정보를 알릴 때, 여러 **BGP 속성**도 함께 알린다. 접두사와 그 속성을 합쳐 **경로(route)** 라고 부른다. 중요한 속성 두 가지는 `AS-PATH`와 `NEXT-HOP`이다.

- **AS-PATH**: 이 속성은 접두사 정보가 거쳐온 AS들의 목록이다. 접두사가 특정 AS로 전달될 때마다 해당 AS는 자신의 ASN(자율 시스템 번호)을 `AS-PATH` 목록에 추가한다. 이 속성은 라우팅 루프를 탐지하고 방지하는 데 사용된다. 라우터가 자신의 AS가 경로 목록에 포함된 것을 보면, 그 정보를 거부한다.

- **NEXT-HOP**: ㅇ외부 as 라우터 인터페이스의 IP 주소이다. 이는 AS 간 라우팅과 AS 내부 라우팅을 연결한다. 예를 들어 Figure 5.10에서 AS1의 라우터들은 접두사 `x`에 대해 두 개의 BGP 경로를 학습한다. 각 경로는 `(NEXT-HOP, AS-PATH, 목적지 접두사)`의 세 가지 요소로 구성된다.
    

### Hot Potato Routing

**Hot Potato 라우팅**은 가능한 경로들 중에서 `NEXT-HOP` 라우터까지의 비용이 가장 적은 경로를 선택하는 간단한 라우팅 알고리즘이다. 라우터는 자신의 AS 내부 라우팅 정보(예: OSPF)를 참조하여 각 `NEXT-HOP` 라우터까지의 최소 비용 경로를 찾고, 그중 가장 작은 비용을 가진 경로를 선택한다.

이 아이디어는 패킷을 가능한 한 빨리 자신의 AS 밖으로 내보내는 것이다. 이는 자신의 AS 내에서의 비용을 줄이려는 이기적인 알고리즘으로, AS 외부의 경로 비용은 무시한다. 이 때문에 같은 AS 내의 다른 라우터들이 동일한 접두사에 대해 서로 다른 AS 경로를 선택할 수도 있다.

### 경로 선택 알고리즘

실제 BGP는 Hot Potato 라우팅을 포함하지만 더 복잡한 알고리즘을 사용한다. 라우터가 특정 접두사에 대해 두 개 이상의 경로를 학습하면, 하나의 경로만 남을 때까지 다음 제거 규칙을 순차적으로 적용한다.

1. **로컬 선호도 (Local Preference)**: 각 경로에는 로컬 선호도 값이 할당된다. 이 값은 AS의 네트워크 관리자가 정책에 따라 설정한다. 가장 높은 로컬 선호도 값을 가진 경로가 선택된다.
    
2. **최단 AS-PATH**: 남아있는 경로들 중에서 `AS-PATH`가 가장 짧은 경로가 선택된다.
    
3. **Hot Potato 라우팅**: 여전히 여러 경로가 남아있다면, `NEXT-HOP` 라우터가 가장 가까운 경로를 선택한다.
    
4. **BGP 식별자**: 그래도 여러 경로가 남으면, 라우터는 BGP 식별자를 사용하여 경로를 선택한다.
    

이 알고리즘에서 `AS-PATH` 규칙이 Hot Potato 라우팅 규칙보다 먼저 적용되기 때문에 BGP는 단순히 이기적인 알고리즘이 아니다. 먼저 AS 경로가 짧은 경로를 찾아 종단 간 지연을 줄이려고 시도한다.
