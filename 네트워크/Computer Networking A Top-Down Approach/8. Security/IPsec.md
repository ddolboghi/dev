# IPsec이란?
- 네트워크 계층의 IP 보안 프로토콜이다.
- 두 네트워크 계층 개체(e.g. 호스트, 라우터) 간의 IP 데이터그램을 보호한다.
- 기관들은 공용 인터넷을 통해 VPN을 구축하기 위해 IPsec을 사용한다.
- IPsec은 네트워크 계층에서 송신 개체가 수신 개체로 보내는 모든 데이터그램의 **페이로드를 암호화**한다.
	- 암호화된 페이로드는 TCP 세그먼트, UDP 세그먼트, ICMP 메시지 등이 될 수 있다.
	- 암호화를 통해 네트워크를 스니핑할 수 있는 제3자로부터 숨겨진다.
- IPsec은 수신 개체가 보안 데이터그램의 출발지를 확인할 수 있도록 **소스 인증**을 제공한다.
- IPsec은 수신 개체가 데이터그램의 변조를 확인할 수 있도록 **데이터 무결성**을 제공한다.
- IPsec은 수신 개체가 공격자가 삽입할 수 있는 중복 데이터그램을 감지할 수 있도록 하여 **재생 공격 방지(replay-attack prevention)** 기능을 제공한다.
# AH와 ESP 프로토콜
- IPsec 프로토콜 중 주요 프로토콜로 인증 헤더(Authentication Header, AH) 프로토콜과 캡슐화 보안 페로드(Encapsulation Security Payload, ESP) 프로콜이 있다.
- 출발지 IPsec 개제가 목적지 개체로 보안 데이터그램을 보낼 때, AH 또는 ESP 프로토콜 중 하나를 사용한다.
- AH 프로토콜은 소스 인증과 데이터 무결성을 제공하지만 기밀성은 제공하지 않는다.
- ESP 프로토콜은 소스인증, 데이터 무결성, 기밀성을 제공한다.
- 기밀성은 VPN과 IPsec 애플리케이션에서 필수적이므로 ESP 프로토콜이 널리 사용된다.
# Security Association
- IPsec이 데이터그램을 전송하기 전에 송신 개체와 수신 개체 간에 논리적 연결, Security Association(SA)가 설정되어야 한다.
- SA는 두 개체 간의 단방향(simplex) 연결이다.
- 두 개체가 양방향으로 안전하게 데이터를 주고 받으려면 2개의 SA가 필요하다.
### SA 식별자
- **SPI (Security Parameter Index)**: 32비트 식별자로, 수신 측에서 해당 SA를 찾을 때 사용한다.
- **목적지 IP 주소**: SA의 수신 개체 IP 주소다.
- **보안 프로토콜 식별자**: 사용된 보안 프로토콜(e.g. AH, ESP)을 나타낸다.
## IPsec이 SA를 이용하는 방식
- SA는 상태 정보를 가진다.
- IPsec 개체는 모든 활성화된 SA에 대한 상태 정보를 **보안 연관 데이터베이스(Security Association Database, SAD)** 에 저장한다.
- IPsec 데이터그램을 수신한 개체는 데이터그램 헤더에 있는 SPI를 보고 SAD를 검색하여, 해당 데이터그램을 어떻게 처리할지(인증 키, 암호화 알고리즘 등)를 결정한다. 즉, **SAD로 IPsec 적용 방법을 결정**하는 것이다.
# IPsec 데이터그램
- IPsec에는 **전송 모드**와 **터널 모드**가 있다.
- VPN에는 주로 터널 모드가 사옹된다.
## IPsec 데이터그램의 구조
![[IPsec_datagram_format.png]]
- 페이로드: 원본 IP 데이터그램(IPv4) 전체가 암호화되어 IPsec 데이터그램의 페이로드가 된다.
- ESP 헤더: SPI와 시퀀스 번호 필드를 포함한다.
- ESP Trailer: padding, padding length, next header 필드를 포함한다.
- ESP MAC(인증 데이터): ESP 헤더, 암호화된 데이터, ESP 트레일러 전체에 대한 메시지 인증 코드(MAC)을 담고 있다.
- New IP 헤더: 터널의 양 끝단(e.g. 라우터 R1과 R2)을 출발지와 목적지로 하는 새로운 IP 헤더가 가장 앞에 붙는다. 프로토콜 번호는 50(ESP)으로 설정된다.
## IPsec 데이터그램을 만드는 과정
1. 원본 데이터그램 뒤에 padding과 ESP 트레일러 필드를 붙인다.
2. 1번의 결과를 SA에서 합의된 알고리즘(e.g. AES-CBC)으로 암호화한다.
3. 암호화된 데이터 앞에 ESP 헤더를 붙인다.
4. 알고리즘과 시크릿 키를 사용해 MAC을 계산하고, 이를 뒤에 붙인다.
5. 터널 엔드포인트 주소를 가진 새 IP 헤더를 앞에 붙인다.

수신측에서는 이 과정을 역순으로 수행한다.
1. 헤더의 SPI를 통해 적절한 SA를 찾는다.
2. 시퀀스 번호를 확인하여 재전송 공격을 방지한다.
3. MAC을 검증한다.
4. 데이터를 복호화한다.
5. 원본 IP 데이터그램을 추출하여 최종 목적지로 전달한다.
## SPD (Security Policy Database)
- 라우터가 어떤 패킷을 IPsec으로 처리할지 결정하기 위해 SPD를 사용한다.
- SPD는 출발지 IP, 목적지 IP, 프로토콜 종류 등에 따라 어떤 패킷을 IPsec으로 변환하고 어떤 SA를 사용할지 정의한다.
- 즉, SPD는 **무엇을 IPsec으로 처리할지**를 다룬다.
# IPsec의 키 관리
IPsec이 동작하려면 통신하는 두 개체가 사전에 SA에 대한 정보(알고리즘, 키 등)를 공유해야 한다.

## 수동 키 관리
- VPN의 엔드포인트 수가 적은 경우, 네트워크 관리자가 직접 각 개체의 SAD에 SA 정보를 수동으로 입력할 수 있다.
- 엔드포인트가 수백, 수천 개에 달하는 대규모 VPN이나 모바일 사용자가 많은 환경에서는 수동 관리가 불가능하다.
## 자동 키 관리 (IKE)
- 대규모 환경의 확장성 문제를 해결하기 위해 IKE(Internet Key Exchange) 프로토콜이 사용된다.
- 목적: IPsec 개체 간에 인증을 수행하고, SA를 자동으로 생성 및 협상하며, 필요한 암호화 키를 교환하는 과정을 자동화한다.
- 동작 방식: IKE는 SSL(TSL) handshake와 유사하다. 각 IPsec 엔터티는 공개키가 포함된