# IPsec이란?
- 네트워크 계층의 IP 보안 프로토콜이다.
- 두 네트워크 계층 개체(e.g. 호스트, 라우터) 간의 IP 데이터그램을 보호한다.
- 기관들은 공용 인터넷을 통해 VPN을 구축하기 위해 IPsec을 사용한다.
- IPsec은 네트워크 계층에서 송신 개체가 수신 개체로 보내는 모든 데이터그램의 **페이로드를 암호화**한다.
	- 암호화된 페이로드는 TCP 세그먼트, UDP 세그먼트, ICMP 메시지 등이 될 수 있다.
	- 암호화를 통해 네트워크를 스니핑할 수 있는 제3자로부터 숨겨진다.
- IPsec은 수신 개체가 보안 데이터그램의 출발지를 확인할 수 있도록 **소스 인증**을 제공한다.
- IPsec은 수신 개체가 데이터그램의 변조를 확인할 수 있도록 **데이터 무결성**을 제공한다.
- IPsec은 수신 개체가 공격자가 삽입할 수 있는 중복 데이터그램을 감지할 수 있도록 하여 **재생 공격 방지(replay-attack prevention)** 기능을 제공한다.
# AH와 ESP 프로토콜
- IPsec 프로토콜 중 주요 프로토콜로 인증 헤더(Authentication Header, AH) 프로토콜과 캡슐화 보안 페로드(Encapsulation Security Payload, ESP) 프로콜이 있다.
- 출발지 IPsec 개제가 목적지 개체로 보안 데이터그램을 보낼 때, AH 또는 ESP 프로토콜 중 하나를 사용한다.
- AH 프로토콜은 소스 인증과 데이터 무결성을 제공하지만 기밀성은 제공하지 않는다.
- ESP 프로토콜은 소스인증, 데이터 무결성, 기밀성을 제공한다.
- 기밀성은 VPN과 IPsec 애플리케이션에서 필수적이므로 ESP 프로토콜이 널리 사용된다.
# Security Association
- IPsec이 데이터그램을 전송하기 전에 송신 개체와 수신 개체 간에 논리적 연결, Security Association(SA)가 설정되어야 한다.
- SA는 두 개체 간의 단방향(simplex) 연결이다.
- 두 개체가 양방향으로 안전하게 데이터를 주고 받으려면 2개의 SA가 필요하다.
### SA 식별자
- **SPI (Security Parameter Index)**: 32비트 식별자로, 수신 측에서 해당 SA를 찾을 때 사용한다.
- **목적지 IP 주소**: SA의 수신 개체 IP 주소다.
- **보안 프로토콜 식별자**: 사용된 보안 프로토콜(e.g. AH, ESP)을 나타낸다.
## IPsec이 SA를 이용하는 방식
- SA는 상태 정보를 가진다.
- IPsec 개체는 모든 활성화된 SA에 대한 상태 정보를 **보안 연관 데이터베이스(Security Association Database, SAD)** 에 저장한다.
- IPsec 데이터그램을 수신한 개체는 데이터그램 헤더에 있는 SPI를 보고 SAD를 검색하여, 해당 데이터그램을 어떻게 처리할지(인증 키, 암호화 알고리즘 등)를 결정한다.
# IPsec 데이터그램
- IPsec에는 **전송 모드**와 **터널 모드**가 있다.
- VPN에는 주로 터널 모드가 사옹된다.
## IPsec 데이터그램의 구조
- 원본 IP 데이터그램(IPv4) 전체가 암호화되어 IPsec 데이터그램의 페이로드가 된다.
