- TCP 세그먼트는 **헤더 필드**와 **데이터 필드**로 구성된다.
- 데이터 필드는 애플리케이션 데이터 덩어리를 포함하며, MSS에 의해 크기가 제한된다.
- TCP 헤더는 일반적으로 20byte다.

# 주요 헤더 필드
![[TCP_segment_structure.png | 600]]
- 출발지 포트 번호와 목적지 포트 번호 필드: UDP와 마찬가지로 상위 계층에 있는 애플리케이션에 데이터를 다중화/역다중화하기 위해 사용된다.
- 체크섬 필드(Internet checksum)
- 32-bit sequence number 필드, 32-bit acknowledgment number 필드: TCP 송신자와 수신자신뢰성있는 데이터 전송 서비스를 구현하는데 사용된다.
- 16-bit 수신 윈도우 필드: 흐름 제어에 사용되며, 수신자가 수용할 수 있는 바이트 수를 나타낸다.
- 4-bit 헤더 길이 필드: TCP 헤더 길이를 32bit로 지정한다. 옵션 필드 때문에 가변적일 수 있다. 옵션 필드가 비어있으면 일반적인 헤더 길이가 된다.
- 옵션 필드: 가변 길이의 선택적 필드로, 송신자와 수신자가 MSS를 협상하거나 고속 네트워크에서 윈도우 크기 조절 인자로 사용된다.
- 플래그 필드: 6bit로 구성된다.
	- **ACK**: 확인 응답 필드의 값이 유효함을 나타낸다.
	- **RST**, **SYN**, **FIN**: 연결 설정 및 해제에 사용된다.
	- **CWR**, **ECE**: 명시적 혼잡 알림에 사용된다.
	- **PSH**: 수신자가 데이터를 즉시 상위 계층으로 전달해야 함을 나타낸다.
	- **URG**: 세그먼트에 긴급(urgent) 데이터가 있음을 나타낸다.
- 긴급 데이터 포인터 필드(Urgent data pointer field): URG 비트가 설정되었을 때 긴급 데이터의 마지막 byte 위치를 가리킨다.
# Sequence Number & Acknowledgment Number
TCP는 데이터를 구조화되지 않은 순서있는 **바이트 스트림**으로 간주한다. 따라서 sequence number는 전송된 세그먼트의 순서가 아닌, 전송된 바이트 스트림을 기준으로 메겨진다.

세그먼트의 sequence number는 **해당 세그먼트에 포함된 데이터의 첫 번째 바이트가 전체 데이터 스트림에서 몇 번째 바이트인지**를 나타낸다.
![[dividing_file_data_into_TCP_segments.png]]
위 그림에서 500000byte 파일을 MSS 1000byte로 전송할때, 첫 번째 세그먼트의 sequence number는 0, 두 번째는 1000, 세 번째는 2000이 된다.

**ACK number(확인 응답 번호)는 수신을 기대하는 다음 바이트의 sequence number**다.
예를 들어, A가 B로부터 0부터 535번 바이트까지 모두 수신했다면, A는 B에게 보내는 세그먼트의 ACK number에 536을 넣는다.
![[simple_telnet_TCP.png | 500]]
위 그림은 Telnet의 TCP 동작이다. ACK number가 어떻게 다음 sequence number 값이 되는지만 살펴보면 된다.
1. A의 초기 sequence number는 42고, 서버로부터 받은 데이터가 없으므로 sequence number는 42, ACK number는 79로 보낸다.
2. B는 A에게 다음에 받을 sequence number값을 ACK number에 넣고, sequence number는 초기 값인 79를 넣어 보낸다.
3. A는 sequence number 79를 받고 다음에 받은 sequence number인 80을 ACK number에 넣는다.
세그먼트에 데이터와 함께 확인 응답을 함께 보내는 것을 piggybacked이라고 한다.
### 누적 확인 응답
TCP는 스트림에서 **첫 번째로 누락된 바이트까지만 확인 응답**한다.
예를 들어, 만약 A가 0~535번 바이트를 수신한 후, 900~1000번 바이트를 수신했다면 아직 536~899번 바이트가 도착하지 않았으므로 A는 여전히 536번 바이트를 기다리고 있는 상태다. 따라서 다음에 B에게 보내는 세그먼트의 ACK number는 여전히 536이다.
### 순서가 뒤바뀐 세그먼트 처리
TCP RFC는 순서가 뒤바뀐 세그먼트의 처리에 대해 구체적으로 명시하지 않는다.
두가지 구현 방식이 있다:
1. 즉시 폐기
2. 누락된 바이트가 채워질 때까지 버퍼에 보관
실제로는 네트워크 대역폭 효율성을 위해 버퍼에 보관하는 방식이 주로 사용된다.
### 초기 순서 번호
TCP 연결의 양측은 임의로 초기 순서 번호를 선택한다.
이는 이전에 종료된 연결에서 네트워크에 남아있던 세그먼트가, 새로운 연결의 유효한 세그먼트로 오인될 가능성을 최소화하기 위함이다.