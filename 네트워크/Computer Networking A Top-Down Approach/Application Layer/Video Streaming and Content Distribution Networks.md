# Internet Video
스트리밍 저장 비디오 애플리케이션에서 사용자들은 서버에 요청을 보내 서버에 저장된 비디오를 시청한다.

비디오는 일반적으로 초당 24 또는 30개의 이미지를 일정한 속도로 표시하는 이미지 시퀀스이다. 압축되지 않은 디지털 인코딩 이미지는 픽셀 배열로 구성되며, 각 픽셀은 휘도와 색상을 나타내기 위해 여러 비트로 인코딩된다.
비디오의 중요한 특징은 **압축이 가능하다**는 것이다. 오늘날의 압축 알고리즘은 비디오를 원하는 거의 모든 비트 전송률로 압축할 수 있으며, 비트 전송률이 높을수록 이미지 품질과 사용자 시청 경험이 향상된다.

네트워킹 관점에서 비디오의 가장 두드러진 특징은 높은 비트 전송률이다. 압축된 인터넷 비디오는 저화질의 경우 100kbps에서 고화질 영화 스트리밍의 경우 4Mbps 이상까지 다양하다. 이는 특히 고품질 비디오의 경우 막대한 양의 트래픽과 저장 공간을 의미할 수 있다. 
스트리밍 비디오의 가장 중요한 성능 척도는 **평균 종단 간 처리율**이다. 지속적인 재생을 제공하기 위해 네트워크는 스트리밍 애플리케이션에 압축된 비디오의 비트 전송률 이상의 평균 처리율을 제공해야 한다.

압축을 사용하여 동일한 비디오의 여러 버전을 각각 다른 품질 수준으로 만들 수도 있다. 예를 들어, 300kbps, 1Mbps, 3Mbps의 세 가지 버전으로 만들면 사용자는 현재 사용 가능한 대역폭에 따라 시청할 버전을 선택할 수 있다.

# HTTP Streaming and DASH

**HTTP 스트리밍**에서는 비디오가 특정 URL을 가진 일반 파일로 HTTP 서버에 저장된다. 
1. 사용자가 비디오를 보려고 하면, 클라이언트는 서버와 TCP 연결을 설정하고 해당 URL에 대한 HTTP GET 요청을 보낸다. 
2. 서버는 기본 네트워크 프로토콜과 트래픽 조건이 허용하는 한 최대한 빨리 HTTP 응답 메시지 내에 비디오 파일을 보낸다. 
3. 클라이언트 측에서는 바이트가 클라이언트 애플리케이션 버퍼에 수집된다. 
4. 이 버퍼의 바이트 수가 미리 정해진 임계값을 초과하면, 클라이언트 애플리케이션은 재생을 시작한다.

이러한 HTTP 스트리밍은 널리 사용되었지만, 클라이언트의 대역폭이 다양함에도 불구하고 **모든 클라이언트가 동일한 인코딩의 비디오를 받는다**는 큰 단점이 있다. 이로 인해 **DASH(Dynamic Adaptive Streaming over HTTP)** 라는 새로운 유형의 HTTP 기반 스트리밍이 개발되었다.

DASH에서는 **비디오가 여러 다른 버전으로 인코딩**되며, 각 버전은 다른 비트 전송률과 그에 상응하는 다른 품질 수준을 가진다. 클라이언트는 몇 초 길이의 비디오 세그먼트 청크를 동적으로 요청한다. 사용 가능한 대역폭이 높을 때는 클라이언트가 자연스럽게 높은 전송률 버전의 청크를 선택하고, 대역폭이 낮을 때는 낮은 전송률 버전의 청크를 선택한다. 클라이언트는 각 청크에 대해 HTTP GET 요청 메시지로 URL과 바이트 범위를 지정하여 한 번에 하나씩 청크를 선택한다.

DASH는 서로 다른 인터넷 접속 속도를 가진 클라이언트가 다른 인코딩 속도로 비디오를 스트리밍할 수 있게 한다. 또한, 세션 중에 사용 가능한 종단 간 대역폭이 변경되면 클라이언트가 이에 적응할 수 있게 해준다.

DASH를 사용하면 각 비디오 버전이 다른 URL로 HTTP 서버에 저장된다. HTTP 서버에는 각 버전의 URL과 비트 전송률을 제공하는 **매니페스트 파일**도 있다. 클라이언트는 먼저 매니페스트 파일을 요청하여 다양한 버전에 대해 알게 된다. 그런 다음, 각 청크에 대해 HTTP GET 요청 메시지에 URL과 바이트 범위를 지정하여 한 번에 하나의 청크를 선택한다. 청크를 다운로드하는 동안 클라이언트는 수신된 대역폭을 측정하고, 다음에 요청할 청크를 선택하기 위해 속도 결정 알고리즘을 실행한다.

# CDN(Content Distribution Networks)
오늘날 많은 인터넷 비디오 회사들은 매일 수백만 명의 사용자에게 수 Mbps의 주문형 스트리밍을 배포하고 있다. 이 모든 트래픽을 전 세계적으로 스트리밍하면서 지속적인 재생과 높은 상호작용성을 제공하는 것은 어려운 작업이다.

가장 간단한 접근 방식은 단일 대규모 데이터 센터를 구축하고 모든 비디오를 그곳에 저장하여 전 세계 클라이언트에게 직접 스트리밍하는 것이다. 하지만 이 방식에는 세 가지 주요 문제가 있다:
1. 클라이언트가 데이터 센터에서 멀리 떨어져 있으면 서버-클라이언트 패킷이 많은 통신 링크를 거쳐야 하고, 이 중 하나의 링크라도 처리율이 비디오 소비율보다 낮으면 종단 간 처리율이 저하되어 사용자에게 끊김 현상이 발생한다.
2. 인기 있는 비디오는 동일한 통신 링크를 통해 여러 번 전송될 가능성이 높아 네트워크 대역폭을 낭비하게 되며, 인터넷 비디오 회사는 제공업체 ISP에 동일한 바이트를 반복적으로 전송하는 비용을 지불해야 한다.
3. 단일 데이터 센터는 단일 장애 지점이 되어, 데이터 센터나 그 링크가 다운되면 비디오 스트림을 전혀 배포할 수 없게 된다.

이러한 문제를 해결하기 위해 거의 모든 주요 비디오 스트리밍 회사는 **콘텐츠 전송 네트워크(Content Distribution Networks, CDN)** 를 사용한다. 
CDN은 지리적으로 분산된 여러 위치에 서버를 관리하고, 비디오(및 다른 웹 콘텐츠)의 복사본을 이 서버에 저장하며, 각 사용자 요청을 최상의 사용자 경험을 제공할 CDN 위치로 유도하려고 시도한다. CDN은 콘텐츠 제공업체가 직접 소유하는 **사설 CDN(private CDN)**(예: Google의 CDN)이거나, 여러 콘텐츠 제공업체를 대신하여 콘텐츠를 배포하는 **제3자 CDN(third-party CDN)**(예: Akamai, Limelight)일 수 있다.

CDN은 일반적으로 두 가지 서버 배치 철학 중 하나를 채택한다:
- **Enter Deep**: 이 방식은 전 세계 ISP의 접속 네트워크 깊숙이 서버 클러스터를 배포하는 것이다. 그러면 사용자에게 더 가까이 다가가 사용자 체감 지연과 처리율을 높일 수 있다. Akamai가 이 접근 방식을 사용하여 수천 곳에 클러스터를 배치했다.
- **Bring Home**: 이 방식은 더 적은 수의 사이트(예: 수십 곳)에 대규모 클러스터를 구축하여 ISP들을 "가져오는" 것이다. 이 CDN들은 일반적으로 인터넷 교환 지점(IXP)에 클러스터를 배치한다. 이 설계는 일반적으로 유지 관리 오버헤드가 낮지만, 최종 사용자에게 더 높은 지연과 낮은 처리율을 초래할 수 있다.

CDN은 클러스터가 배치되면 **콘텐츠를 클러스터 간에 복제**한다. 일부 비디오는 거의 보지 않거나 특정 국가에서만 인기가 있기 때문에 모든 비디오의 복사본을 모든 클러스터에 배치하지 않을 수도 있다. 
많은 CDN은 **풀(pull)** 전략을 사용한다: 클라이언트가 비디오를 저장하지 않은 클러스터에 요청하면, 해당 클러스터는 비디오를 검색하여 **클러스터에 복사본을 저장하면서 동시에 클라이언트에게 스트리밍**한다.

## CDN 동작 방식
사용자 호스트의 브라우저가 특정 비디오(URL로 식별됨)를 검색하도록 지시받으면, CDN은 요청을 가로채서 (1) 그 시점에 해당 클라이언트에 적합한 CDN 서버 클러스터를 결정하고, (2) 클라이언트의 요청을 해당 클러스터의 서버로 리디렉션해야 한다.

대부분의 CDN은 DNS를 이용하여 요청을 가로채고 리디렉션한다.
![[DNS_redirect_example.png | 500]]
1. 사용자가 NetCinema의 웹 페이지를 방문한다.
2. 사용자가 비디오 링크를 클릭하면, 사용자 호스트는 `video.netcinema.com`에 대한 DNS 쿼리를 보낸다.
3. 사용자의 로컬 DNS 서버(LDNS)는 이 쿼리를 NetCinema의 권한 DNS 서버로 전달한다. NetCinema의 DNS 서버는 `video`라는 문자열을 보고, IP 주소 대신 KingCDN 도메인의 호스트 이름(예: `a1105.kingcdn.com`)을 LDNS에 반환하여 DNS 쿼리를 KingCDN에 "넘겨준다".
4. 이제 DNS 쿼리는 KingCDN의 사설 DNS 인프라로 들어간다. 사용자의 LDNS는 `a1105.kingcdn.com`에 대한 두 번째 쿼리를 보내고, KingCDN의 DNS 시스템은 최종적으로 KingCDN 콘텐츠 서버의 IP 주소를 LDNS에 반환한다.
5. LDNS는 콘텐츠 제공 CDN 노드의 IP 주소를 사용자 호스트로 전달한다.
6. 클라이언트는 KingCDN 콘텐츠 서버의 IP 주소를 받으면, 해당 IP 주소의 서버와 직접 TCP 연결을 설정하고 비디오에 대한 HTTP GET 요청을 보낸다. DASH가 사용되는 경우, 서버는 먼저 클라이언트에게 매니페스트 파일을 보내고, 클라이언트는 동적으로 다른 버전의 청크를 선택한다.
## 클러스터 선택 전략
클러스터 선택 전략은 클라이언트를 CDN 내의 서버 클러스터나 데이터 센터로 동적으로 유도하는 메커니즘이다. CDN은 클라이언트의 DNS 조회를 통해 얻은 클라이언트의 Local DNS 서버 IP 주소를 기반으로 적절한 클러스터를 선택해야 한다. 몇 가지 접근 방식은 다음과 같다:
- **지리적으로 가장 가까운 클러스터 할당**: 상용 지리 위치 데이터베이스를 사용하여 각 LDNS IP 주소를 지리적 위치에 매핑한다. DNS 요청이 특정 LDNS에서 수신되면, CDN은 지리적으로 가장 가까운 클러스터를 선택한다. 이 방식은 대부분의 클라이언트에게 잘 작동할 수 있지만, 지리적으로 가장 가까운 클러스터가 네트워크 경로 길이 면에서 가장 가깝지 않을 수 있다는 문제가 있다.
- **실시간 측정 기반 선택**: CDN은 클라이언트와 클러스터 간의 지연 및 손실 성능에 대한 주기적인 실시간 측정을 수행할 수 있다. 예를 들어, 각 클러스터가 전 세계의 모든 LDNS에 주기적으로 프로브(예: ping 메시지 또는 DNS 쿼리)를 보낼 수 있다. 하지만 많은 LDNS가 이러한 프로브에 응답하지 않도록 구성되어 있다는 것이 단점이다.
# Case Studies: Netflix and YouTube

## Netflix

2020년 기준으로 넷플릭스의 비디오 배포는 **AWS**와 자체 **사설 CDN 인프라**라는 두 가지 주요 구성 요소로 이루어져 있다.
넷플릭스의 웹사이트와 관련 백엔드 데이터베이스는 전적으로 AWS에서 실행된다. 또한 AWS는 다음과 같은 중요한 기능을 처리한다:
- **콘텐츠 수집**: 넷플릭스는 영화사로부터 마스터 버전의 영화를 받아 아마존 클라우드의 호스트에 업로드한다.
- **콘텐츠 처리**: AWS의 기기들은 각 영화에 대해 다양한 클라이언트 비디오 플레이어에 적합한 여러 형식의 버전을 만든다. 각 형식마다 여러 비트 전송률로 버전이 생성되어 DASH를 사용한 HTTP 기반 적응형 스트리밍을 지원한다.
- **CDN에 버전 업로드**: 영화의 모든 버전이 생성되면, AWS의 호스트들은 이 버전들을 넷플릭스의 CDN에 업로드한다.

넷플릭스는 자체 사설 CDN을 구축하여 현재 모든 비디오를 스트리밍하고 있다. 이를 위해 넷플릭스는 IXP(인터넷 교환 지점)와 주거용 ISP 내부에 서버 랙을 설치했다. 이 서버들은 대용량 저장 공간을 갖추고 있으며, 넷플릭스 비디오 라이브러리 전체 또는 일부 인기 비디오를 저장한다. 넷플릭스는 **push caching** 방식을 사용하여 비피크 시간에 CDN 서버로 비디오를 배포한다.

클라이언트와 서버 간의 상호 작용은 다음과 같다(Figure 2.26 참조)
1. 사용자가 영화를 선택하면, AWS에서 실행되는 넷플릭스 소프트웨어는 해당 영화의 복사본을 가진 CDN 서버 중 "최상의" 서버를 결정한다. 
2. 클라이언트에게 특정 서버의 IP 주소와 함께 요청된 영화의 다른 버전에 대한 URL 목록이 포함된 매니페스트 파일을 보낸다.
3. 클라이언트와 해당 CDN 서버는 DASH의 독점 버전을 사용하여 직접 상호 작용한다.
4. 클라이언트는 수신된 처리율을 측정하고 속도 결정 알고리즘을 실행하여 다음에 요청할 청크의 품질을 결정한다.
## YouTube
넷플릭스와 마찬가지로 유튜브도 비디오 배포를 위해 CDN 기술을 광범위하게 사용한다. 구글은 자체 사설 CDN을 사용하여 유튜브 비디오를 배포하며, 수백 개의 IXP 및 ISP 위치에 서버 클러스터를 설치했다. 넷플릭스와 달리 구글은 **pull caching**과 **DNS 리디렉션**을 사용한다. 구글의 클러스터 선택 전략은 대부분의 경우 클라이언트와 클러스터 간의 RTT(왕복 시간)가 가장 낮은 클러스터로 클라이언트를 유도하지만, 클러스터 간의 부하를 분산시키기 위해 때때로 더 먼 클러스터로 유도하기도 한다.

유튜브는 **HTTP 스트리밍**을 사용하며, 비디오에 대해 몇 가지 다른 버전(각각 다른 비트 전송률과 품질 수준)을 제공한다. DASH와 같은 적응형 스트리밍은 사용하지 않고, 사용자가 수동으로 버전을 선택해야 한다. 유튜브는 재배치나 조기 종료로 인한 대역폭 및 서버 자원 낭비를 막기 위해 HTTP 바이트 범위 요청을 사용하여 목표량의 비디오가 프리페치된 후 전송 데이터 흐름을 제한한다.

유튜브 업로더들도 HTTP를 통해 클라이언트에서 서버로 비디오를 업로드한다. 유튜브는 수신된 각 비디오를 처리하여 유튜브 비디오 형식으로 변환하고 다른 비트 전송률로 여러 버전을 만든다. 이 처리는 전적으로 구글 데이터 센터 내에서 이루어진다.