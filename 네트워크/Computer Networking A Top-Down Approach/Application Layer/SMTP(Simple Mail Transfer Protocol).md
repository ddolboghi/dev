# 인터넷 메일 시스템의 구성 요소
- 사용자 에이전트: 사용자가 메시지를 읽고, 답장, 전달, 저장, 작성할 수 있도록 한다. Gmail, Outlook 등이 사용자 에이전트의 예시다.
- 메일 서버: 수신 메시지를 위한 메일함과 발신 메시지를 위한 발신 메시지 큐를 저장한다. 메일 서버는 SMTP를 실행하며, 이 프로토콜을 사용하여 다른 메일 서버와 이메일 메시지를 주고받는다.
- 송신자가 메시지 작성을 마치면, 송신자의 사용자 에이전트는 메시지를 송신자의 메일 서버로 전송하고, 메시지는 메일 서버의 **발신 메시지 큐**에 저장된다. 수신자가 메시지를 읽고 싶을 때, 수신자의 사용자 에이전트는 수신자의 메일 서버에 있는 **메일함(mailbox)** 에서 메시지를 검색한다.
- SMTP는 **TCP**를 기본 전송 프로토콜로 사용하며, **포트 번호 25**를 통해 동작한다.
- SMTP는 **수신자의 메일 서버에서 수신자의 사용자 에이전트로 메일을 전송하는 데는 사용되지 않는다**.
# SMTP 클라이언트 - 서버 상호작용
- **SMTP는 중간 서버를 거치지 않고**, 클라이언트 측 서버와 서버 측 서버가 **직접 통신**한다.
- SMTP는 TCP의 신뢰할 수 있는 데이터 전송 서비스를 사용한다.
- SMTP는 다른 애플리케이션 계층의 프로토콜처럼 클라이언트 사이드(수신자의 메일 서버)과 서버 사이드(송신자의 메일 서버)를 가지며, 모든 메일 서버가 두 사이드를 가진다.
- SMTP 클라이언트는 전송하는 메일 서버를 의미하고, SMTP 서버는 수신하는 메일 서버를 의미한다.
- SMTP는 SMTP 클라이언트의 큐에서 SMTP 서버의 메일함으로 메시지를 직접 전송하는 직접 전송 프로토콜이다. 이는 HTTP의 pull 프로토콜과 달리, SMTP는 push 프로토콜이라는 점이 특징이다.
## 이메일 전송 시나리오
앨리스가 밥에게 이메일을 보낼 때
1. 앨리스는 호스트 A의 사용자 에이전트를 사용하여 메시지 작성
2. 호스트 A의 사용자 에이전트는 앨리스의 메일 서버(e.g. mail.cs.umass.edu)로 메시지를 보낸다. 메시지는 메일 서버의 발신 메시지 큐에 저장된다.
3. 앨리스의 메일 서버(SMTP 클라이언트)는 밥의 메일 서버(e.g. mail.cs.nyn.edu)로 **TCP 연결** 설정
4. SMTP 클라이언트(앨리스의 메일 서버)와 SMTP 서버(밥의 메일 서버)는 핸드셰이킹을 수행한다. 이과정에서 클라이언트는 자신의 호스트 이름을, 서버는 준비 상태를 알린다. 클라이언트는 수신자의 이메일 주소를 보내고, 서버는 해당 수신자가 존재하는지 여부를 확인한다.
5. 핸드셰이킹이 완료된 후, 앨리스의 메일 서버는 메시지를 밥의 메일 서버로 전송한다.
6. 밥의 메일 서버는 메시지를 밥의 메일함에 저장한다.
7. 밥은 자신의 사용자 에이전트를 사용하여 메시지를 읽는다.

만약 밥의 메일 서버가 다운된 경우, 앨리스의 메일 서버는 메시지를 큐에 저장하고 나중에 다시 전송을 시도한다. 재시도 간격은 일반적으로 30분 이상이다.
일정 기간 동안 전송에 실패하면, 메시지는 큐에서 제거되고 앨리스에게 전송 실패 보고서가 보내진다.
# SMTP 연결 및 메시지 형식
- SMTP는 HTTP/1.1과 유사하게 **지속 연결(persistent connections)** 을 사용한다. 
- SMTP는 메시지가 **7비트 ASCII 형식**이어야 한다. 따라서 이미지와 같은 비ASCII 데이터는 전송 전에 ASCII로 인코딩되어야 한다.
- 메일 메시지 헤더 라인는 SMTP 명령어와 다른, 메일 메시지 자체의 일부다.
## 메일 메시지 헤더
일반적인 우편 편지와 마찬가지로, 이메일 메시지도 본문 앞에 수신자 주소, 발신자 회신 주소, 날짜와 같은 주변 정보를 포함하는 **헤더**가 있다.
## 헤더 형식 및 내용
이러한 정보는 일련의 헤더 줄에 포함되어 있으며, RFC 5322에서 정의된다. 헤더 줄과 메시지 본문은 **빈 줄(CRLF)** 로 구분된다. RFC 5322는 메일 헤더 줄의 정확한 형식과 의미론적 해석을 명시한다. 각 헤더 줄은 **키워드 뒤에 콜론(:)과 값이 오는 형태**로 구성된 읽을 수 있는 텍스트다.
## 필수 및 선택 헤더
모든 헤더에는 **From:** 과 **To:** 헤더 라인이 반드시 포함되어야 한다. 헤더에는 **Subject:** 과 기타 선택적 헤더 라인도 포함될 수 있다.

# Mail Access Protocol
![[email_protocol.png]]
- 메일 서버가 사용자 에이전트에 메시지를 전송할때는 pull 동작을 할 수 있는 HTTP나 IMAP 프로토콜을 사용한다.
- 사용자 에이전트가 메일 서버에 메시지를 전송할때는 push 동작을 할 수 있는 HTTP나 SMTP를 사용한다.
- 메일 서버는 다른 메일 서버로부터 메시지를 주고받기 위해 여전히 SMTP를 사용한다.
- **IMAP (Internet Mail Access Protocol)** 와 HTTP 둘다 메일 서버에 있는 메시지를 조작할 수 있다.