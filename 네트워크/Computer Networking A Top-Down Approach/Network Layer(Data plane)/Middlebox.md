**미들박스(Middlebox)** 는 라우터의 표준 전달 기능 외에 NAT, 보안, 성능 향상과 같은 추가 기능을 데이터 경로상에서 수행하는 중개 장치이다.
RFC 3234는 미들박스를 "소스 호스트와 목적지 호스트 사이의 데이터 경로에서 IP 라우터의 정상적인 표준 기능 외의 기능을 수행하는 모든 중개 장치"로 정의한다.
# 미들박스의 서비스 유형
- **NAT**: NAT 박스는 사설 네트워크 주소 지정을 구현하며, 데이터그램 헤더의 IP 주소와 포트 번호를 재작성한다.
- **보안 서비스**: 방화벽은 헤더 필드 값을 기준으로 트래픽을 차단하거나, 심층 패킷 검사(DPI)와 같은 추가 처리를 위해 패킷의 경로를 변경한다. 침입 탐지 시스템(IDS)은 미리 정의된 패턴을 탐지하여 패킷을 필터링한다. 애플리케이션 수준의 이메일 필터는 스팸, 피싱 등 보안 위협으로 간주되는 이메일을 차단한다.
- **성능 향상**: 이 유형의 미들박스는 압축, 콘텐츠 캐싱, 서비스 요청에 대한 로드 밸런싱과 같은 서비스를 수행한다.
# NFV (Network Function Virtualization)
- SDN에서 사용된 접근법과 유사하게 범용 하드웨어(네트워킹, 컴퓨팅, 스토리지)에 공통 소프트웨어 스택을 기반으로 한 전문 소프트웨어를 사용하여 미들박스 서비스를 구현하는 것이다.
- 미들박스의 확산으로인한 운영 및 관리의 복잡성 증가를 해결하기 위해 모색된 방안이다.
- 또 다른 대안으로 미들박스 기능을 클라우드에 아웃소싱하는 방안도 탐구되고 있다.
# 미들박스와 인터넷 아키텍처
오랜 기간 인터넷 아키텍처는 네트워크 계층과 그 상위 계층(전송/애플리케이션) 사이에 명확한 분리가 있었다. 과거에는 네트워크 계층이 네트워크 코어 내에서 IP 데이터그램 헤더 필드만을 사용하여 패킷을 전달하는 라우터로 구성되었다. 반면 전송 및 애플리케이션 계층은 네트워크 엣지에 있는 호스트에서 구현되었다.

오늘날의 미들박스는 이러한 계층 분리 원칙을 명확히 위반한다. 예를 들어, NAT 박스는 라우터와 호스트 사이에 위치하여 네트워크 계층의 IP 주소와 전송 계층의 포트 번호를 모두 재작성한다. 네트워크 내 방화벽은 애플리케이션, 전송, 네트워크 계층 헤더 필드를 모두 사용하여 의심스러운 데이터그램을 차단한다. 이메일 보안 게이트웨이는 이메일 발신자와 수신자 사이에 위치하여 IP 주소뿐만 아니라 이메일 메시지 내용까지 필터링한다.

일부에서는 이러한 미들박스를 아키텍처의 "흉물"로 여기기도 하지만, 다른 한편에서는 미들박스가 "중요하고 영구적인 이유로 존재"하며, 앞으로 더 많아질 것이라는 철학을 채택한다. 이는 미들박스가 네트워크의 중요한 요구를 충족시키고 있음을 의미한다.

> "많은 인터넷 커뮤니티 구성원들은 아키텍처가 없고 단지 전통만 있다고 주장할 것이다... 그러나 매우 일반적인 용어로, 커뮤니티는 **연결성**이 목표이고, 그 도구는 **인터넷 프로토콜(IP)** 이며, 지능은 네트워크에 숨겨져 있기보다는 **종단 간(end to end)** 에 있다고 믿는다." [RFC 1958]

## IP 모래시계
![[internet_hourglass.png | 300]]
위 그림처럼 인터넷 프로토콜 스택은 물리, 링크, 전송, 애플리케이션 계층에는 수많은 프로토콜이 존재하지만, 네트워크 계층에는 **오직 하나의 프로토콜, 즉 IP 프로토콜만** 존재한다.
이 좁은 허리 구조는 인터넷의 경이로운 성장에 결정적인 역할을 했다. IP 프로토콜의 상대적인 단순성과 인터넷 연결을 위한 유일한 보편적 요구사항이라는 점 덕분에, 이더넷부터 WiFi, 셀룰러, 광 네트워크에 이르기까지 매우 다양한 하위 링크 계층 기술을 가진 네트워크들이 인터넷의 일부가 될 수 있었다.
## 종단 간 논쟁
RFC 1958의 세 번째 원칙인 "지능은 종단 간에 있다"는 네트워크 내 기능의 배치 위치에 관한 것이다. 이는 매우 영향력 있는 논문 [Saltzer 1984]에서 제기된 "End-to-End Argument"에 근거한다. 이 논쟁의 핵심은 다음과 같다.

> "문제의 기능은 통신 시스템의 양 끝단에 있는 애플리케이션의 지식과 도움 없이는 완전하고 정확하게 구현될 수 없다. 따라서 해당 기능을 통신 시스템 자체의 기능으로 제공하는 것은 불가능하다."

예를 들어, **신뢰성 있는 데이터 전송**은 종단 간에 구현되어야 한다. 네트워크 내에서 패킷이 손실될 수 있으므로, 종단(이 경우 TCP 프로토콜)에서 오류 제어를 수행해야 한다. 일부 링크 계층 프로토콜이 로컬 오류 제어를 수행하더라도, 이는 "불완전"하며 종단 간 신뢰성을 보장하기에는 충분하지 않다. 따라서 신뢰성 있는 데이터 전송은 반드시 종단 간에 구현되어야 한다.