---
chapter: "4"
---
# IPv4 데이터그램 형식
![[IPv4_datagram_format.png]]
- **Version number (버전 번호)**: 4bit 필드. 데이터그램의 IP 프로토콜 버전을 명시한다. 라우터는 이 버전 번호를 보고 데이터그램의 나머지 부분을 어떻게 해석할지 결정한다. IPv4는 이 필드 값이 4다.
- **Header length (헤더 길이)**: 4bit 필드. IP 데이터그램에서 페이로드(e.g. 이 데이터그램안에 캡슐화된 전송 계층 세그먼트)가 실제로 시작되는 위치를 결정하는 데 필요하다. 대부분의 IP 데이터그램은 가변 길이 옵션을 포함하지 않으므로 일반적으로 20byte 헤더를 가진다.
- **Type of service (서비스 유형)**: 이 필드로 서로 다른 유형의 IP 데이터그램을 구별한다. 예를 들어, 실시간 데이터그램(IP 전화 애플리케이션)과 비실시간 트래픽(FTP)을 구별할 수 있다. 이 중 2비트는 명시적 혼잡 알림(Explicit Congestion Notification)에 사용된다.
- **Datagram length (데이터그램 길이)**: IP 데이터그램의 전체 길이(헤더 + 데이터)를 byte 단위로 나타낸다. 이 필드는 16bit이므로 이론상 최대 크기는 65,535byte($2^{16} - 1$)다. 그러나 데이터그램은 일반적으로 1,500바이트를 넘지 않는다.
    
- **Identifier, flags, fragmentation offset (식별자, 플래그, 단편화 오프셋)**: 이 세 필드는 큰 IP 데이터그램이 여러 개의 작은 데이터그램으로 나뉘는 **IP 단편화(IP fragmentation)** 와 관련이 있다. 단편화된 데이터그램들은 목적지까지 독립적으로 전달된 후, 페이로드 데이터가 전송 계층으로 전달되기 전에 재조립된다. IPv6에서는 단편화를 허용하지 않는다.
    
- **Time-to-live (TTL, 생존 시간)**: 데이터그램이 네트워크에서 영원히 순환하는 것을 방지하기 위해 포함된다. 이 필드는 데이터그램이 라우터를 통과할 때마다 1씩 감소하며, TTL 필드가 0이 되면 라우터는 해당 데이터그램을 폐기해야 한다.
    
- **Protocol (프로토콜)**: 이 필드는 데이터그램이 최종 목적지에 도달했을 때만 사용된다. 필드의 값은 이 IP 데이터그램의 데이터 부분을 어떤 전송 계층 프로토콜로 전달해야 하는지를 나타낸다. 예를 들어, 값이 6이면 TCP로, 17이면 UDP로 데이터가 전달된다. 이 프로토콜 번호는 네트워크 계층과 전송 계층을 연결하는 역할을 한다.
    
- **Header checksum (헤더 체크섬)**: 라우터가 수신한 IP 데이터그램의 비트 오류를 감지하는 데 도움을 준다. 헤더의 각 2바이트를 숫자로 취급하고 1의 보수 연산으로 합산하여 계산된다. TTL 필드 등이 라우터마다 변경되므로, 체크섬은 각 라우터에서 다시 계산되고 저장되어야 한다. TCP/UDP와 IP 모두에서 오류 검사를 수행하는 이유는, IP 헤더만 IP 계층에서 체크섬되고 TCP/UDP 세그먼트는 전체에 대해 체크섬이 계산되기 때문이며, 또한 TCP가 IP가 아닌 다른 프로토콜 위에서 실행될 수도 있기 때문이다.
    
- **Source and destination IP addresses (출발지 및 목적지 IP 주소)**: 출발지 호스트가 데이터그램을 생성할 때, 자신의 IP 주소를 출발지 IP 주소 필드에, 최종 목적지의 주소를 목적지 IP 주소 필드에 삽입한다.
    
- **Options (옵션)**: IP 헤더를 확장할 수 있게 해주는 필드이다. 드물게 사용되도록 의도되었으나, 옵션의 존재는 데이터그램 헤더 길이를 가변적으로 만들어 데이터 필드의 시작 위치를 예측하기 어렵게 한다. 이러한 이유로 IPv6 헤더에는 옵션 필드가 포함되지 않았다.
    
- **Data (payload, 데이터)**: 데이터그램의 가장 중요한 부분으로, 대부분의 경우 목적지로 전달될 전송 계층 세그먼트(TCP 또는 UDP)를 포함한다. 그러나 ICMP 메시지와 같은 다른 유형의 데이터를 전달할 수도 있다.

# DHCP (Dynamic Host Configuration Protocol)
- 네트워크에 연결된 장치에 IP 주소와 기타 네트워크 설정 정보를 자동으로 할당하는 프로토콜
- DHCP를 이용하면 연결된 장치마다 수동으로 IP 주소를 할당하지 않아도 된다.
- DHCP는 기본 게이트웨이의 IP 주소도 제공한다.
- DHCP 서버는 엣지 라우터에 있다.
- DHCP 서버는 장치가 네트워크에 연결되면 IP 주소를 할당하고, 네트워크 연결이 끊기면 IP 주소를 회수한다.
## DHCP 프로토콜 과정(6.7.1)
chp 4의 4단계 중 마지막 두 단계만 실제로 필요하다.
1. 운영체제가 DHCP 요청 메시지를 UDP 세그먼트에 넣는다. 이때 destination 포트는 DHCP 서버 포트인 67이고, 소스 포트는 DHCP 클라이언트 포트인 68이다. UDP 세그먼트는 브로드캐스트 IP destination 주소와 0.0.0.0의 소스 IP 주소를 가지고 IP 데이터그램안에 위치한다.
2. IP 데이터그램은 이더넷프레임 내에 배치된다. 이더넷프레임은 destination MAC 주소를 가지고 스위치에 연결된 모든 장치들에 전파된다. 이때 이더넷프레임의 소스 MAC 주소는 내 컴퓨터의 MAC 주소다.
3. 2의 이더넷 프레임은 내 컴퓨터가 이더넷 스위치로 전송하는 첫번째 프레임이다. 스위치는 들어온 프레임을 라우터와 연결된 포트를 포함한 모든 아웃 포트로 전파한다.
4. 라우터는 자신의 MAC 주소를 가진 인터페이스에서 DHCP 요청이 포함된 이더넷프레임을 수신하고 이더넷프레임에서 IP 데이터그램을 추출한다. 데이터그램의 브로드캐스트 IP destination 주소는 이 IP 데이터그램이 이 노드에서 상위계층 프로토콜에 의해 처리되어야 함을 나타낸다. 따라서 데이터그램의 페이로드(UDP 세그먼트)는 UDP까지 demultiplexed 되고, DHCP 요청 메지가 UDP 세그먼트로부터 추출된다.
5. 라우터 안에서 돌아가고 있는 DHCP 서버는 CIDR 블록 내의 IP 주소를 할당한다. DHCP 서버는 DHCP ACK 메시지를 만드는데, 이 안에는 할당할 IP 주소, DNS 서버의 IP 주소, 기본 게이트웨이의 IP 주소, subnet block(네트워크 마스크)이 들어있다. DHCP 메시지는 UDP 세그먼트 안에 들어가고, UDP 세그먼트는 IP 데이터그램 안에 들어가며, IP 데이터그램은 이더넷프레임 안에 들어간다. 이더넷프레임 안에는 라우터가 속한 네트워크에 대한 라우터 인터페이스의 소스 MAC 주소와 내 컴퓨터의 destination MAC 주소가 들어있다.
6. DHCP ACK를 포함한 이더넷프레임은 라우터에 의해서 스위치로 보내진다. 스위치는 2에서 DHCP 요청이 포함된 이더넷프레임을 받은 적이 있기 때문에 프레임의 destination MAC 주소를 보고 내 컴퓨터로 연결되는 포트에만 전달한다.
7. 내 컴퓨터는 이더넷프레임을 수신하고나서 IP 데이터그램 -> UDP 세그먼트 -> DHCP ACK 메시지 순서로 추출한다. DHCP 클라이언트는 DHCP ACK 메시지 안에서 할당받은 IP 주소와 DNS 서버의 IP 주소를 기록한다. 그리고 기본 게이트웨이의 주소를 IP 포워딩 테이블에 설치한다. 그러면 이제부터 내 컴퓨터는 subnet 밖의 대상 주소를 갖는 모든 데이터그램을 기본 게이트웨이로 받게 된다. 이제 내 컴퓨터는 네트워크 컴포넌트로 초기화되고, 웹페이지 페치를 시작할 준비를 한다.