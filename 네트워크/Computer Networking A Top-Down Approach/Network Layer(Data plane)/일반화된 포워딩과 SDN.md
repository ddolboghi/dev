# 일반화된 포워딩
- 라우터가 목적지 IP 주소를 기반으로 패킷을 전달하는 것 외에도 로드 밸런싱, 방화벽, NAT 기능 등이 필요할 수 있다.
- 일반화된 포워딩은 패킷 헤더 값들을 기반으로 전달(forward), 차단(block), 복사(copy)하여 패킷을 특정 포트로 보낼 수 있다. 이러한 정교한 패킷 처리는 SDN(Software-Defined Networking) 아키텍처의 데이터 영역에서 핵심적인 역할을 한다.
- 라우터는 **플로우 테이블(flow table)** 을 가지며, 이 테이블의 각 항목은 패킷 헤더 값에 대한 **매치(match)** 규칙과 그에 따른 **액션(action)** 으로 구성된다.
- 플로우 테이블은 원격 컨트롤러에 의해 계산, 설치, 갱신된다.
# Match
일반화된 포워딩 프레임워크의 첫 번째 부분은 패킷 헤더 필드의 값과 플로우 테이블 항목을 비교하는 **매치(match)** 작업이다.
## 매치 필드
다양한 프로토콜 계층의 여러 헤더 필드가 플로우 테이블의 매치 규칙에 사용될 수 있다.
- 링크 계층: 수신 스위치 포트, 출발지/목적지 MAC 주소, 이더넷 타입, VLAN ID, VLAN Pri
- 네트워크 계층: IP 프로토콜, 출발지/목적지 IP 주소, IP ToS(서비스 유형) 필드 등
- 전송 계층: TCP/UDP 소스/목적지 포트 번호, TCP 플래그 등
    
플로우 테이블의 각 항목은 이 필드들의 값, 비트마스크, 우선순위를 포함할 수 있다. 
패킷이 도착하면, 라우터는 가장 높은 우선순위를 가진 매칭 항목을 찾아 그에 해당하는 액션을 수행한다. 매칭되는 항목이 없으면 컨트롤러로 패킷을 보내거나 패킷을 폐기하는 등의 기본 액션을 취한다.
## OpenFlow
이러한 일반화된 Match+Action 개념은 **OpenFlow** 표준에서 비롯되었다. OpenFlow는 SDN 컨트롤 영역과 데이터 영역 간의 통신을 위한 표준 프로토콜이다.

# Action
플로우 테이블에서 패킷이 특정 항목과 매치되면, 해당 항목에 정의된 **액션(action)** 이 수행된다.
## 주요 액션
각 플로우 테이블 항목에는 0개 이상의 액션 목록이 있으며, 이 액션들은 패킷에 순서대로 적용될 수 있다.
- **포워딩 (Forwarding)**: 가장 기본적인 액션으로, 패킷을 특정 물리적 출력 포트로 전달한다. 또한, 패킷을 컨트롤러로 보내거나(네트워크 관리 및 제어 목적), 원래 수신 포트로 다시 보내거나(브로드캐스트), 정의된 가상 회로(터널)로 전달할 수도 있다.
- **폐기 (Dropping)**: 명시적인 액션이 없는 경우, 패킷은 폐기된다. 이는 보안 정책(방화벽)을 구현하는 데 유용하다.
- **수정 (Modify-field)**: 패킷이 스위치를 통과하면서 헤더의 특정 필드 값을 수정할 수 있다. 예를 들어, VLAN ID를 추가/제거하거나 MAC 또는 IP 주소를 변경하는 등의 작업이 가능하다. 이는 NAT 구현의 기초가 된다.
## Match + Action
다양한 매치와 액션을 조합하여 결합하면 라우터, 스위치, 방화벽, NAT 등 다양한 네트워크 장치의 기능을 구현할 수 있다.
예를 들어, 목적지 IP 주소 프리픽스에만 매치하고 출력 포트로 포워딩하는 액션을 설정하면 전통적인 IP 라우터와 동일하게 동작한다.

# OpenFlow 예시
![[OpenFlow_example.png]]
## 간단한 포워딩
h5, h6의 패킷이 s3 -> s1 -> s2를 거쳐 h3, h4로 포워딩된다고 가정

s3의 플로우 테이블:

| Match                                     | Action     |
| ----------------------------------------- | ---------- |
| 출발지 IP = `10.3.*.*` ; 목적지 IP = `10.2.*.*` | Forward(3) |
s1의 플로우 테이블:

| Match                                                        | Action     |
| ------------------------------------------------------------ | ---------- |
| Ingress Port = 1 ; 출발지 IP = `10.3.*.*` ; 목적지 IP = `10.2.*.*` | Forward(4) |
s2의 플로우 테이블:

| Match                                                                        | Action                   |
| ---------------------------------------------------------------------------- | ------------------------ |
| Ingress Port = 2 ; 목적지 ip = 10.2.0.3<br>Ingress Port = 2 ; 목적지 ip = 10.2.0.4 | Forward(3)<br>Forward(4) |
## 로드 밸런싱(Load Balancing)
h3의 패킷이 s2 -> s1을 거쳐 `10.1.*.*`로 향하고, h4의 패킷이 s2 -> s3 -> s1을 거쳐 `10.1.*.*`으로 포워딩된다고 가정

s2의 플로우 테이블:

| Match                                                                            | Action                   |
| -------------------------------------------------------------------------------- | ------------------------ |
| Ingress Port = 3 ; 목적지 IP = `10.1.*.*`<br>Ingress Port = 4 ; 목적지 IP = `10.1.*.*` | Forward(2)<br>Forward(1) |
s3의 플로우 테이블:

| Match                                  | Action     |
| -------------------------------------- | ---------- |
| Ingress Port = 4 ; 목적지 IP = `10.1.*.*` | Forward(3) |
s1의 플로우 테이블:

| Match                                  | Action     |
| -------------------------------------- | ---------- |
| Ingress Port = 1 ; 목적지 IP = `10.1.*.*` | Forward(3) |