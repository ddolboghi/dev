[우아콘2023-대규모 트랜잭션을 처리하는 배민 주문시스템 규모에 따른 진화](https://www.youtube.com/watch?v=704qQs6KoUk)를 보고 정리한 글

# 시스템간 이벤트 기반 통신
MSA를 적용한 이유는 중앙 집중 DB의 장애가 전체 시스템으로 전파될 수 있기 때문이다.
예를 들어 여러 시스템(서비스)이 하나의 DB에 의존한다면 특정 시스템의 부하가 DB의 부하를 일으키고, 이 DB에 의존하는 다른 시스템까지 부하가 걸리게 된다.

각자 시스템에 맞는 도메인을 설계해 DB를 따로 만들었다.

시스템간 영향도를 분리하기위해 MSA를 적용하며 Message Queue를 이용한 이벤트 기반 통신을 구축했다.

A시스템이 B시스템에 관심있을때 메세지 큐에 지연이 발생하면 서비스가 지연되지만, 
메세지 큐는 이벤트를 재소비할 수 있어 B시스템이 이벤트를 재발행하여 빠르게 서비스 안정화 가능하다.

이벤트 기반 통신은 시스템간 느슨한 결합을 가져와 시스템간 영향도를 분리할 수 있다.

# CQRS 패턴
루트 엔티티 기반으로 여러 엔티티로 구성된 애그리거트: 도메인 주도 설계에서 사용되는 용어 같다.
간단히 이해하자면, 루트 엔티티는 중심 역할의 테이블이고 다른 엔티티는 정규화된 부수적인 테블들이다.
예를 들어, 경매 테이블이 루트 엔티티라면 이에 기반한 다른 엔티티들은 경매 내역 테이블, 이미지 테이블이다.
## 조회와 쓰기용 DB를 분리한 이유
RDBMS는 하나의 도메인(애그리거트)에 대해서 정규화된 여러 테이블을 조인하게되면 조회 성능이 나빠진다.

 > [!tip] 조회 성능을 높이기 위해 루트 엔티티 기반으로 구성된 애그리거트를 역정규화를 통해 단일 도큐먼트로 만든다.
 
 NoSQL 중 하나인 mongoDB를 사용할 수 있다.
 단순 id 값만으로 필요한 모든 데이트를 한번에 쿼리하여 조회 성능을 개선할 수 있다.
## 동기화 방법
도메인의 생명주기를 먼저 파악해야한다.
경매는 경매 생성 -> 입찰 -> 낙찰 -> 경매 종료의 라이프사이클을 가진다고 생각한다.

**도메인 라이프사이클 안에서만 데이터의 변경이 일어난다.**

![[우아콘2023_데이터_동기화.png]]
1. 주문 API에서 주문 도메인 내 데이터 변경 발생
2. 주문 이벤트 발행
3. 주문이벤트 처리 애플리케이션에서 데이터 동기화
4. mongoDB에 데이터 실시간으로 공개
# 대규모 트랜잭션
대규모 트랜잭션은 쓰기 요청이 폭발적으로 증가하는 상황을 말한다.

![[우아콘2023_대규모트랜잭션_전.png]]
쓰기용 DB를 스펙업만 하다가 한계에 다다랐다.

데이터베이스 샤딩으로 쓰기
